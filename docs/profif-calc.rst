Алгоритм расчета доходности
===========================

Всё было неправильно

Доход/убыток рождается:
1. Доход со счета income. Перечисление процентов по вкладу, дивидендов
2. Покупка продажа инструмента по разным ценам.


У транзакции нужно брать только одну часть. Иначе пойдет задвоение

Если у транзакции всего 2 проводки:
Отфильтровать по типам счетов для учета xirr
Взять одну по приоритету типов счетов

Нужно взять ту часть, которая относится к нужному типу счетов для учета xirr

Если у транзакции больше двух проводок:


-------------------------------------------------


Для счета stock
---------------

Предполагается, что

* Не используется расчет капитальных прибылей/убытков (через наборы)
* Дивиденды привязываются к счету бумаги

Тогда получаем примерно такие проводки (censored)

Для подсчета годового % для курсовой стоимости:
Берем все value (сумма оборотов, сумма покупки/продажи ценных бумаг. Возможно нужен пересчет в валюту) по типу Stock.
Если есть остаток бумаг, добавляем их текущую стоимость с минусом на текущую дату.
По этим значениям считаем xirr.

Для подсчета полной доходности, нужно прибавить к этому списку движения по INCOME связанные с этим счетом (Взять value)

Как считать дивидендную доходность непонятно. Возможно простой разницей между полной и курсовой (!?)
По аэрофлоту похоже на правду.

Доходность вкладов
------------------

Предполагается, что:

* Проценты начисляются на тот же счет

Для подсчета полной доходности нужно:

Взять все value (оборот по счету), вычесть из них те, что пересекаются с INCOME на тот же счет.
Если на счету есть остаток, добавить его на нужную дату, но с минусом
Посчитать xirr

Если проценты идут на другой счет?

Нужно добавить в список для xirr строчки по счету INCOME пересекающиеся со счетом для которого считается доходность.
Но пойдет неправильная доходность у счета на который приходят проценты!
Хотя если я снял столько сколько положил, то доходность 0%

доходность для всех типов
-------------------------

Считать по xirr, по составленным спискам:

Курсовая доходность:

* взять движения по счету
* выкинуть из движений по счету пересекающиеся суммы по INCOME (если есть, это для вкладов)
* Если есть остаток по счету, добавить его значение в валюте учета с минусом на конечную дату
* если не сначала учета счета, то на начальную дату добавить остаток счета (положительный)

Полная доходность (добавить к пунктам курсовой доходности):

* добавить не пересекающиеся суммы по INCOME

Дивидендная доходность (предположительно):

Полная доходность - Курсовая




